# Nacos注册中心

Nacos是Dynamic Naming and Configuration Service的首字母简称，定位于一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。

## 1、注册中心概念

**价值**：解决分布式场景下，服务之间互相发现的问题

**流程**：服务提供方注册实例信息到注册中心；服务消费者订阅服务提供者的变更；当服务提供方实例信息变更时，注册中心推送最新的实例信息给服务消费者；服务消费者通过服务提供者的实例信息对服务提供者发起调用

**误区**：服务消费者调用服务提供者的时候请求需要经过注册中心

![注册中心图](..\Resource\Nacos\注册中心.png)

## 2、持久化实例VS临时实例

**持久化实例**：通常适用于mysql、redis等无法引用SDK的服务，一旦注册**实例会一直存在**，直到被**手动注销**

**临时实例**：注册后通过**心跳**或者**长连接**方式与服务端保持健康检查，一旦心跳丢失一定时间或者长连接断开实例会**自动被注销**

| 对比项   | 临时实例     | 持久化实例 |
| ------------------------------ | -------- | -------- |
| 是否能主动与服务端维持健康检查    | 是   | 否       |
| 优先级     | 默认   | 需要参数指定      |
| grpc注册    | 支持 | 不支持       |
| 是否自动注销   | 是     | 否       |

## 3、服务注册-Client发起注册

**补偿机制**：SDK发起注册后会定时补偿，保证最终注册成功（临时实例）；网络异常或者服务端宕机导致连接断开，SDK无限重连，重新发起注册，保证数据不丢失（临时实例）；**持久化实例注册无补偿机制**

![临时实例补偿图](..\Resource\Nacos\临时实例补偿.png)

## 4、服务注册-Server处理注册

![server处理注册图](..\Resource\Nacos\server处理注册.png)

## 5、服务注册-一致性DistroVSJRaft

| 对比项   | Distro     | 持久化实例 |
| ------------------------------ | -------- | -------- |
| 协议类型    | AP（保证可用性）   | CP（保证一致性）       |
| Nacos应用场景     | 临时实例数据   | 持久化实例数据；持久化服务数据；实例元数据；配置数据（不使用mysql）      |
| 实现原理    | 1.每个节点都可接受写请求 2.定时对账 3.异步同步 | 基于Raft协议实现一致性，只有Leader才能接受写请求       |
| 优缺点   | 性能高，数据最终一致     | 强一致性，性能相比Distro协议低，对磁盘敏感       |

## 6、健康检查-临时实例

![健康检查图](..\Resource\Nacos\健康检查.png)

* 1.x版本通过客户端主动定时上报心跳来维持健康状态，实例不健康的时间可以通过**preserved.heart.beat.timeout**参数来设置，实例被删除的时间可以通过**preserved.ip.delete.timeout**参数来设置，服务端通过多线程和定时任务来进行检查
* 2.x版本依赖grpc长连接来维持健康状态，当grpc连接断开实例被删除

## 7、健康检查-持久化实例

* 健康检查协议：TCP（默认）、MySQL协议、HTTP协议、不检查

![健康检查持久化实例图](..\Resource\Nacos\健康检查持久化实例.png)

## 8、服务发现-订阅与推送

**订阅**：订阅是为了收到推送，订阅也有补偿机制

当发生推送时，如果连接处于断开状态，则不会重试，仅仅网络异常，但是连接还在的时候推送失败会重试

![推送过程图](..\Resource\Nacos\推送过程.png)

## 9、服务发现-查询

![服务发现查询图](..\Resource\Nacos\服务发现查询.png)

## Nacos的QA

* 1. Q：假如Nacos有三个节点，是三个节点都在检查，还是只有一个节点?
     A：Nacos会把健康检查任务分布到集群的每个节点中，假如Nacos服务有三个节点，总共有9个服务实例，那每个节点是负责三个实例的健康检查。

* 2. Q：Nacos节点挂了，节点检查xx？
     A：如果Nacos某个节点挂了，这个节点负责的客户端会感知到并且重新注册到其他节点，少数节点宕机不影响整体可用性，所有节点宕机不影响运行中的服务。

3. Q：客户端，服务端之间沟通有安全问题吗？
     A：目前不管是Nacos的1.x的http请求需要经过鉴权，2.x的版本客户端与服务端创建grpc连接的时候也需要经过鉴权。

4. Q：nacos的distro协议是最终一致，如果有强一致的需求咋办，也就是有没有办法一定能拿到最新的数据？nacos的订阅消息可能会丢失么？
     A：持久化实例的jraft协议就是强一致的。订阅操作客户端同样具有补偿机制，客户端与服务端连接断线重连会重新发起订阅，客户端还有一个1分钟执行一次的兜底的定时任务来保证数据一致，另外客户端每次重启都会全量拉取服务端所有数据，所以数据不会丢失。

5. Q：我们发现 nacos客户端会把配置信息打印到日志中，这个有开关可以关闭吗
      A：可以通过日志框架的过滤功能屏蔽这个日志。

6. Q：从健康检查初次出现问题，到确认实例不健康，实例仍然会被当作可用的节点吗？如果觉得这个时间阈值太久，能否自己调节？
      A：1.x版本的临时实例健康检查到实例删除的时间默认是30秒，在实例被删除期间都会被当做可用节点，可用通过在控制台实例列表修改元数据设置preserved.ip.delete.timeout 来修改这个时间，但是建议直接升级到2.1.0的nacos-client的版本，因为2.x版本健康检查依赖的是grpc的连接状态，可以秒级感知到实例下线。

7. Q：nacos的密码明文有解决策略吗？
A：目前keycenter相关SDK可以支持nacos账号密码明文密码加密的问题。

8. Q：请问你们的nacos集群是物理机部署，还是容器上？
A：目前部署在物理机上，因为nacos容器化部署目前社区不活跃，测试发现了一些问题，暂时为了稳定性不打算容器化部署。

9. Q：后面有服务治理相关的规划吗？
A：目前还在收集相关需求，可以联系我们一起聊一下。

10. Q：历史版本修改版本好像记录的不太准，中间有版本丢失
A：目前还没有收到用户反馈相关的bug，理论上历史修改信息不会丢失，再次出现时可直接找到我们一起排查。

11. Q：msp 中配置部分，目前没有权限限制，任何人都可以修改，能否支持权限类限制
A：权限是基于IAM的，目前IAM支持设置只读权限，可以对个人或这用户组单独授权。微服务平台(MSP)用户文档 ,对权限如果有更多需求可以再详聊。

12. Q：nacos在集团中的使用情况怎么样？
A：目前 Nacos在集团使用很广泛，我们负责的Nacos集群有100+个pdl在使用。

13. Q：我们现在配置中心的账号系统，是否可以和小米的账号对接上？
A：Nacos目前的控制台Msp是使用IAM做权限控制。微服务平台(MSP)用户文档  ,对权限如果有更多需求可以再详聊。

14. Q：怎样保证多集群配置一致性， 怎样又保证多集群配置的差异性？
A：MSP 目前有多集群发布的接口，支持发到多区域；差异性可以通过设置不同的group来实现。微服务平台(MSP)用户文档 

15. Q：健康时间检查，临时注册，Nacos做了哪些措施来扛住这么大的压力？
A：Nacos是集群模式部署，健康检查任务都平均分配到不同的节点，当监控发现资源不足时，我们会提前监控到并且做扩容。

16. Q：Nacos会自动扩容吗
A：目前不支持，会提前手动扩容，Q3目前有这个想法，Q4会做自动扩容


