# JVM调优

GC 日志分析算是 JVM 调优中比较难的部分，聊聊如何利用 JDK 现有的命令并且借助可视化工具去分析 GC 日志。

## JVM 实践调优主要步骤

**第一步，监控分析 GC 日志**

**第二步，判断 JVM 问题**

* 如果各项参数设置合理，系统没有超时日志出现，GC 频率不高，GC 耗时不高，那么没有必要进行 GC 优化
* 如果 GC 时间超过 1-3 秒，或者频繁 GC，则必须优化

**第三步，确定调优目标**

**第四步，调整参数**

* 调优一般是从满足程序的内存使用需求开始，之后是时间延迟要求，最后才是吞吐量要求，要基于这个步骤来不断优化，每一个步骤都是进行下一步的基础，不可逆行之。

**第五步，对比调优前后差距**

**第六步，重复1，2，3，4，5步骤**

* 找到最佳JVM参数设置

**第七步，应用 JVM 到应用服务器**

* 找到最合适的参数，将这些参数应用到所有服务器，并进行后续跟踪。

## 分析 GC 日志

### 初始参数设置

Jvm 调优典型参数设置;

* -Xms 堆内存的最小值：默认情况下，当堆中可用内存小于40%时，堆内存会开始增加，一直增加到-Xmx的大小；
* -Xmx 堆内存的最大值：默认值是总内存/64（且小于 1G），默认情况下，当堆中可用内存大于 70%时，堆内存会开始减少，一直减小到-Xms 的大小；
* -Xmn 新生代内存的最大值：包括 Eden 区和两个 Survivor 区的总和，配置写法如：-Xmn1024k，-Xmn1024m，-Xmn1g
* -Xss 每个线程的栈内存：默认 1M，一般来说是不需要改，线程栈越小意味着可以创建的线程数越多
  
* 整个堆的大小 = 年轻代大小 + 年老代大小，堆的大小不包含元空间大小，如果增大了年轻代，年老代相应就会减小，官方默认的配置为年老代大小/年轻代大小=2/1 左右；

建议在开发测试环境可以用 Xms 和 Xmx 分别设置最小值最大值，但是在线上生产环境，Xms 和 Xmx 设置的值必须一样，防止抖动；

**JVM 调优设置合理大小堆内存空间，既不能太大，也不能太小，那么应该设置为多少呢？**，默认的配置是否存在性能瓶颈。如果想要确定 JVM 性能问题瓶颈，需要进一步分析GC 日志

* -XX:+PrintGCDetails 开启 GC 日志创建更详细的 GC 日志，默认情况下 GC 日志是关闭的
* -XX:+PrintGCTimeStamps，-XX:+PrintGCDateStamps：开启 GC 时间提示
  
* 开启时间便于我们更精确地判断几次 GC 操作之间两个参数的区别
* 时间戳是相对于 0（依据 JVM 启动的时间）的值，而日期戳（date stamp）是实际的日期字符串
* 由于日期戳需要进行格式化，所以它的效率可能会受轻微的影响，不过这种操作并不频繁，它造成的影响也很难被我们感知

* -XX:+PrintHeapAtGC 打印堆的 GC 日志
* -Xloggc:./logs/gc.log 指定 GC 日志路径


